<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HappyHome å®¶åº­ä»»åŠ¡ (ä¼˜åŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    
    <style>
        /* æ•´ä½“ç¾å­¦è°ƒæ•´ï¼šæ›´æŸ”å’Œçš„èƒŒæ™¯å’Œé˜´å½± */
        body { background-color: #f7f3f9; } 
        .shadow-premium { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* æ˜Ÿæ˜Ÿçˆ†å‘åŠ¨ç”» */
        @keyframes star-fade-out {
            0% { transform: scale(0.5) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.5) rotate(10deg); opacity: 0.8; }
            100% { transform: scale(3) rotate(30deg); opacity: 0; }
        }
        .star-burst {
            animation: star-fade-out 0.8s ease-out forwards;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 9999; pointer-events: none;
        }
        
        /* æ­å–œåŠ¨ç”» */
        @keyframes congratulate {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(10deg); opacity: 1; }
            70% { transform: translate(-50%, -50%) scale(0.9) rotate(-5deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .congratulate-popup {
            animation: congratulate 0.6s ease-out forwards;
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            z-index: 9999; 
            pointer-events: none;
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 9998;
            animation: confetti-fall 3s linear forwards;
        }
        /* æ›²çº¿å›¾æ ·å¼ */
        .chart-grid line { stroke: #e5e7eb; stroke-width: 1; }
        .chart-label { font-size: 10px; fill: #6b7280; }
        .chart-line { fill: none; stroke-width: 3; }
        /* å›¾æ ‡ä¿®å¤ï¼šè¡¥å……ä¸€ä¸ªåœ†åœˆå’Œæ‰“é’©å›¾æ ‡ */
        .icon-check-circle { fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    </style>

    <div class="border-blue-500 border-pink-500 border-green-500 bg-blue-500 bg-pink-500 bg-green-500 text-blue-600 text-pink-600 text-green-600 border-red-500 bg-red-500 text-red-600 hidden"></div>
</head>
<body>
    <div id="root"></div>

    <script>
        const { useState, createElement, useMemo } = React;

        // --- 1. å›¾æ ‡ç»„ä»¶ (å®Œæ•´ä¿®å¤ç‰ˆ) ---
        const Icon = ({ children, className, fill = "none" }) => (
            createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: fill, stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className }, children)
        );
        const Icons = {
            Home: (props) => createElement(Icon, props, createElement('path', { d: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}), createElement('polyline', { points: "9 22 9 12 15 12 15 22"})),
            Calendar: (props) => createElement(Icon, props, createElement('rect', { x: "3", y: "4", width: "18", height: "18", rx: "2", ry: "2"}), createElement('line', { x1: "16", y1: "2", x2: "16", y2: "6"}), createElement('line', { x1: "8", y1: "2", x2: "8", y2: "6"}), createElement('line', { x1: "3", y1: "10", x2: "21", y2: "10"})),
            Trophy: (props) => createElement(Icon, props, createElement('path', { d: "M8 21h8"}), createElement('path', { d: "M12 17v-5a6 6 0 0 0-6-6v-2h12v2a6 6 0 0 0-6 6v5"})), 
            Chart: (props) => createElement(Icon, props, createElement('line', { x1: "18", y1: "20", x2: "18", y2: "10"}), createElement('line', { x1: "12", y1: "20", x2: "12", y2: "4"}), createElement('line', { x1: "6", y1: "20", x2: "6", y2: "14"})),
            Star: (props) => createElement(Icon, {...props, fill: props.fill || "none"}, createElement('polygon', { points: "12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})),
            Plus: (props) => createElement(Icon, props, createElement('line', { x1: "12", y1: "5", x2: "12", y2: "19"}), createElement('line', { x1: "5", y1: "12", x2: "19", y2: "12"})),
            Edit: (props) => createElement(Icon, props, createElement('path', { d: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}), createElement('path', { d: "M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})),
            UserPlus: (props) => createElement(Icon, props, createElement('path', { d: "M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}), createElement('circle', { cx: "8.5", cy: "7", r: "4"}), createElement('line', { x1: "20", y1: "8", x2: "20", y2: "14"}), createElement('line', { x1: "23", y1: "11", x2: "17", y2: "11"})),
            Users: (props) => createElement(Icon, props, createElement('path', { d: "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}), createElement('circle', { cx: "9", cy: "7", r: "4"}), createElement('path', { d: "M23 21v-2a4 4 0 0 0-3-3.87"}), createElement('path', { d: "M16 3.13a4 4 0 0 1 0 7.75"})),
            Trash: (props) => createElement(Icon, props, createElement('polyline', { points: "3 6 5 6 21 6"}), createElement('path', { d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})),
            List: (props) => createElement(Icon, props, createElement('line', { x1: "8", y1: "6", x2: "21", y2: "6"}), createElement('line', { x1: "8", y1: "12", x2: "21", y2: "12"}), createElement('line', { x1: "8", y1: "18", x2: "21", y2: "18"}), createElement('line', { x1: "3", y1: "6", x2: "3.01", y2: "6"}), createElement('line', { x1: "3", y1: "12", x2: "3.01", y2: "12"}), createElement('line', { x1: "3", y1: "18", x2: "3.01", y2: "18"})),
            CheckCircle: (props) => createElement(Icon, {...props, fill: props.fill || "none"}, createElement('path', { d: "M22 11.08V12a10 10 0 1 1-5.93-9.14"}), createElement('polyline', { points: "22 4 12 14.01 9 11.01"})),
            Circle: (props) => createElement(Icon, props, createElement('circle', { cx: "12", cy: "12", r: "10" })),
            ChevronLeft: (props) => createElement(Icon, props, createElement('polyline', { points: "15 18 9 12 15 6" })),
            ChevronRight: (props) => createElement(Icon, props, createElement('polyline', { points: "9 18 15 12 9 6" })),
            ChevronUp: (props) => createElement(Icon, props, createElement('polyline', { points: "18 15 12 9 6 15" })),
            ChevronDown: (props) => createElement(Icon, props, createElement('polyline', { points: "6 9 12 15 18 9" })),
            X: (props) => createElement(Icon, props, createElement('line', { x1: "18", y1: "6", x2: "6", y2: "18"}), createElement('line', { x1: "6", y1: "6", x2: "18", y2: "18"})),
            Clock: (props) => createElement(Icon, props, createElement('circle', { cx: "12", cy: "12", r: "10" }), createElement('polyline', { points: "12 6 12 12 16 14"})),
        };


        // --- 2. æ¨¡æ‹Ÿåˆå§‹æ•°æ® (ç®€åŒ–è§’è‰²) ---
        const INITIAL_MEMBERS = [
            { id: 'm1', name: 'çˆ¸çˆ¸', color: 'bg-blue-500', text: 'text-blue-600', border: 'border-blue-500', stars: 10, avatar: 'ğŸ‘¨' },
            { id: 'm2', name: 'å¦ˆå¦ˆ', color: 'bg-pink-500', text: 'text-pink-600', border: 'border-pink-500', stars: 5, avatar: 'ğŸ‘©' },
            { id: 'm3', name: 'æ¡ƒæ¡ƒ', color: 'bg-red-500', text: 'text-red-600', border: 'border-red-500', stars: 12, avatar: 'ğŸ‘§' },
        ];
        const INITIAL_TASKS = [
            { id: 't1', title: 'èµ·åºŠæ´—æ¼±', assignedTo: 'm3', date: '2025-11-26', completed: false, stars: 1, priority: 'high', icon: 'ğŸª¥', taskColor: 'bg-red-100', type: 'individual' },
            { id: 't2', title: 'åšä½œä¸š', assignedTo: 'm3', date: '2025-11-25', completed: true, stars: 1, priority: 'medium', icon: 'ğŸ“’', taskColor: 'bg-green-100', type: 'individual', completedAt: '2025-11-25' },
            { id: 't3', title: 'æ´—ç¢—', assignedTo: 'm1', date: '2025-11-26', completed: false, stars: 1, priority: 'low', icon: 'ğŸ’§', taskColor: 'bg-blue-100', type: 'individual' },
            { id: 't4', title: 'æ•´ç†å®¢å… (ç«äº‰)', assignedTo: 'm2', date: '2025-11-27', completed: false, stars: 5, priority: 'high', icon: 'ğŸ†', taskColor: 'bg-yellow-100', type: 'competition', competitors: ['m2', 'm3'] },
            { id: 't5', title: 'å‘¨æœ«å¤§æ‰«é™¤', assignedTo: 'm1', date: '2025-11-23', completed: true, stars: 2, priority: 'low', icon: 'ğŸ§¹', taskColor: 'bg-blue-100', type: 'individual', completedAt: '2025-11-23' },
            { id: 't6', title: 'è´­ä¹°é£Ÿæ', assignedTo: 'm2', date: '2025-11-24', completed: true, stars: 1, priority: 'medium', icon: 'ğŸ›’', taskColor: 'bg-pink-100', type: 'individual', completedAt: '2025-11-24' },
            // æ›´å¤šå†å²æ•°æ®ç”¨äºæ›²çº¿å›¾æ¼”ç¤º
            { id: 't7', title: 'å€’åƒåœ¾', assignedTo: 'm3', date: '2025-11-22', completed: true, stars: 1, icon: 'ğŸ—‘ï¸', taskColor: 'bg-red-100', type: 'individual', completedAt: '2025-11-22' },
            { id: 't8', title: 'é›ç‹—', assignedTo: 'm3', date: '2025-11-23', completed: true, stars: 1, icon: 'ğŸ•', taskColor: 'bg-red-100', type: 'individual', completedAt: '2025-11-23' },
            { id: 't9', title: 'é“ºåºŠ', assignedTo: 'm2', date: '2025-11-23', completed: true, stars: 1, icon: 'ğŸ›Œ', taskColor: 'bg-pink-100', type: 'individual', completedAt: '2025-11-23' },
            { id: 't10', title: 'ä¿®æ°´é¾™å¤´', assignedTo: 'm1', date: '2025-11-25', completed: true, stars: 3, icon: 'ğŸ”§', taskColor: 'bg-blue-100', type: 'individual', completedAt: '2025-11-25' },
        ];
        const INITIAL_REWARDS = [
            { id: 'r1', name: 'çœ‹åŠ¨ç”»ç‰‡ 30åˆ†é’Ÿ', cost: 5, assignedTo: 'm3', icon: 'ğŸ“º', progress: 3 },
            { id: 'r2', name: '3Dæ‰“å°æœºå¨ƒå¨ƒä¸€ä¸ªä»»é€‰', cost: 10, assignedTo: 'm3', icon: 'ğŸ§¸', progress: 1 },
            { id: 'r3', name: 'æˆ·å¤–æ¢é™©ä¸€æ¬¡', cost: 50, assignedTo: 'm1', icon: 'â›°ï¸', progress: 0 },
            { id: 'r4', name: 'ä¹°æ–°åŒ…åŒ…', cost: 200, assignedTo: 'm2', icon: 'ğŸ‘œ', progress: 0 },
        ];
        const INITIAL_REWARD_HISTORY = [];

        // --- 3. è¾…åŠ©å‡½æ•°ï¼šæ—¥æœŸä¸ç»Ÿè®¡ ---
        const getStartOfWeek = (dateStr) => {
            const date = new Date(dateStr);
            const day = date.getDay(); // 0 for Sunday, 6 for Saturday
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
            const startOfWeek = new Date(date.setDate(diff));
            return startOfWeek.toISOString().slice(0, 10);
        };
        const getDatesInWeek = (startOfWeekStr) => {
            const dates = [];
            const current = new Date(startOfWeekStr);
            for (let i = 0; i < 7; i++) {
                dates.push(current.toISOString().slice(0, 10));
                current.setDate(current.getDate() + 1);
            }
            return dates;
        };

        // --- 4. ç»Ÿè®¡è§†å›¾æ ¸å¿ƒç»„ä»¶ï¼šSVG æ›²çº¿å›¾ ---
        const LineChart = ({ data, color, width, height }) => {
            const padding = 20;
            const innerWidth = width - 2 * padding;
            const innerHeight = height - 2 * padding;

            const values = data.map(d => d.value);
            const maxVal = Math.max(...values, 1);

            const points = values.map((val, index) => {
                const x = padding + (index / (data.length - 1)) * innerWidth;
                const y = padding + innerHeight * (1 - (val / maxVal));
                return { x, y, value: val, label: data[index].label };
            });

            let pathD = `M ${points[0].x} ${points[0].y}`;
            for (let i = 0; i < points.length - 1; i++) {
                const p0 = points[i];
                const p1 = points[i + 1];
                const cp1x = p0.x + (p1.x - p0.x) / 2;
                const cp1y = p0.y;
                const cp2x = p0.x + (p1.x - p0.x) / 2;
                const cp2y = p1.y;
                pathD += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p1.x} ${p1.y}`;
            }

            const gridLines = [];
            const yTicks = [0, Math.floor(maxVal / 2), maxVal].filter((v, i, arr) => arr.indexOf(v) === i && v >= 0);

            yTicks.forEach(tick => {
                const y = padding + innerHeight * (1 - (tick / maxVal));
                gridLines.push(createElement('line', { key: `y-${tick}`, x1: padding, y1: y, x2: width - padding, y2: y, className: "chart-grid" }));
                gridLines.push(createElement('text', { key: `y-label-${tick}`, x: padding - 5, y: y + 3, textAnchor: "end", className: "chart-label" }, tick));
            });
            
            const xLabels = points.map((p, i) => createElement('text', {
                key: `x-label-${i}`, x: p.x, y: height - 5, textAnchor: "middle", className: "chart-label"
            }, p.label));

            return createElement('svg', { width, height, className: "bg-white rounded-lg shadow-inner" },
                // Y è½´å’Œ X è½´
                createElement('line', { x1: padding, y1: padding, x2: padding, y2: height - padding, stroke: "#6b7280" }),
                createElement('line', { x1: padding, y1: height - padding, x2: width - padding, y2: height - padding, stroke: "#6b7280" }),
                
                // ç½‘æ ¼çº¿å’Œæ ‡ç­¾
                ...gridLines,
                ...xLabels,

                // æ›²çº¿
                createElement('path', { d: pathD, className: "chart-line", stroke: color }),
                
                // æ•°æ®ç‚¹åœ†åœˆ
                points.map((p, i) => createElement('circle', { 
                    key: `c-${i}`, cx: p.x, cy: p.y, r: 4, 
                    fill: color, stroke: "white", strokeWidth: 2 
                }))
            );
        };


        // --- 5. ç»Ÿè®¡è§†å›¾ (StatsView) - æ·»åŠ æˆå‘˜æ’å ---
        const StatsView = ({ tasks, members, getMemberById }) => {
            const today = '2025-11-26';
            const [selectedRange, setSelectedRange] = useState('week');
            const [selectedMemberId, setSelectedMemberId] = useState('all');

            const filteredTasks = useMemo(() => {
                let currentTasks = tasks.filter(t => t.completed); 
                
                const startOfWeekStr = getStartOfWeek(today);
                const datesInWeek = getDatesInWeek(startOfWeekStr);
                
                if (selectedRange === 'week') {
                    currentTasks = currentTasks.filter(t => t.completedAt && datesInWeek.includes(t.completedAt));
                }

                if (selectedMemberId !== 'all') {
                    currentTasks = currentTasks.filter(t => t.assignedTo === selectedMemberId);
                }
                
                return currentTasks;
            }, [tasks, selectedRange, selectedMemberId, today]);

            const chartData = useMemo(() => {
                const startOfWeekStr = getStartOfWeek(today);
                const dates = getDatesInWeek(startOfWeekStr);
                
                const dataMap = dates.map(date => ({
                    label: date.slice(5),
                    value: 0,
                    date: date
                }));
                
                filteredTasks.forEach(t => {
                    const index = dataMap.findIndex(d => d.date === t.completedAt);
                    if (index !== -1) {
                        dataMap[index].value += 1;
                    }
                });
                
                return dataMap;
            }, [filteredTasks, today]);

            const totalCompleted = filteredTasks.length;
            const totalStars = filteredTasks.reduce((sum, t) => sum + t.stars, 0);

            // æˆå‘˜æ’å
            const memberRanking = useMemo(() => {
                return members
                    .map(m => {
                        const memberTasks = tasks.filter(t => t.assignedTo === m.id && t.completed);
                        return {
                            ...m,
                            completedCount: memberTasks.length,
                            earnedStars: memberTasks.reduce((sum, t) => sum + t.stars, 0)
                        };
                    })
                    .sort((a, b) => b.earnedStars - a.earnedStars);
            }, [members, tasks]);

            const memberSelector = [
                { id: 'all', name: 'å…¨éƒ¨', avatar: 'ğŸ ' },
                ...members
            ].map(m => createElement('button', {
                key: m.id,
                onClick: () => setSelectedMemberId(m.id),
                className: `px-3 py-1 rounded-full text-sm font-medium transition flex items-center gap-2 ${selectedMemberId === m.id ? `bg-purple-600 text-white shadow-md` : 'bg-gray-100 text-gray-700'}`
            }, m.avatar, m.name));

            return createElement('div', { className: "p-4 pb-20 space-y-6" },
                createElement('h2', { className: "text-2xl font-bold text-gray-800 flex items-center gap-2" }, 
                    createElement(Icons.Chart, { className: "w-7 h-7 text-purple-600" }),
                    'ä»»åŠ¡å®Œæˆç»Ÿè®¡'
                ),
                
                // æˆå‘˜ç­›é€‰
                createElement('div', { className: "flex space-x-3 overflow-x-auto pb-4 scrollbar-hide" }, ...memberSelector),
                
                // æ—¶é—´ç­›é€‰
                createElement('div', { className: "flex gap-3 text-sm font-medium" },
                    createElement('button', { onClick: () => setSelectedRange('week'), className: `px-4 py-2 rounded-full transition ${selectedRange === 'week' ? 'bg-indigo-500 text-white' : 'bg-white text-gray-700 border'}` }, 'æœ¬å‘¨'),
                    createElement('button', { onClick: () => setSelectedRange('month'), disabled: true, className: `px-4 py-2 rounded-full transition bg-white text-gray-400 border` }, 'æœ¬æœˆ (å¾…å¼€å‘)'),
                ),

                // æ±‡æ€»æŒ‡æ ‡
                createElement('div', { className: "grid grid-cols-2 gap-4" },
                    createElement('div', { className: "bg-white p-4 rounded-xl shadow-premium border-l-4 border-indigo-500" }, 
                        createElement('p', { className: "text-sm text-gray-600" }, 'å®Œæˆä»»åŠ¡æ•°'),
                        createElement('p', { className: "text-3xl font-bold text-indigo-700" }, totalCompleted)
                    ),
                    createElement('div', { className: "bg-white p-4 rounded-xl shadow-premium border-l-4 border-yellow-500" }, 
                        createElement('p', { className: "text-sm text-gray-600" }, 'è·å¾—æ˜Ÿæ˜Ÿæ•°'),
                        createElement('div', { className: "flex items-center text-3xl font-bold text-yellow-600" }, totalStars, createElement(Icons.Star, { className: "w-7 h-7 ml-1 fill-current" }))
                    )
                ),

                // æˆå‘˜æ’åæ¦œ
                createElement('div', { className: "bg-white p-4 rounded-xl shadow-premium" },
                    createElement('h3', { className: "text-xl font-bold mb-4 flex items-center gap-2" }, 
                        createElement(Icons.Trophy, { className: "w-6 h-6 text-yellow-600" }),
                        'æˆå‘˜æ’è¡Œæ¦œ'
                    ),
                    createElement('div', { className: "space-y-3" },
                        memberRanking.map((m, index) => {
                            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                            return createElement('div', { 
                                key: m.id, 
                                className: `flex items-center justify-between p-3 rounded-lg ${index === 0 ? 'bg-yellow-50 border border-yellow-200' : 'bg-gray-50'}` 
                            },
                                createElement('div', { className: "flex items-center gap-3" },
                                    createElement('span', { className: "text-2xl font-bold w-8" }, medals[index] || `${index + 1}`),
                                    createElement('div', { className: `w-10 h-10 rounded-full flex items-center justify-center text-xl ${m.color}` }, m.avatar),
                                    createElement('div', null,
                                        createElement('p', { className: "font-bold text-gray-800" }, m.name),
                                        createElement('p', { className: "text-xs text-gray-500" }, `å®Œæˆ ${m.completedCount} ä¸ªä»»åŠ¡`)
                                    )
                                ),
                                createElement('div', { className: "flex items-center gap-2 text-yellow-600 font-bold text-lg" },
                                    createElement(Icons.Star, { className: "w-5 h-5 fill-current" }),
                                    m.earnedStars
                                )
                            );
                        })
                    )
                ),

                // æ›²çº¿å›¾
                createElement('div', { className: "bg-white p-4 rounded-xl shadow-premium" },
                    createElement('h3', { className: "text-xl font-bold mb-4" }, 'æ¯å‘¨ä»»åŠ¡å®Œæˆè¶‹åŠ¿'),
                    createElement(LineChart, { data: chartData, color: "#8b5cf6", width: 350, height: 200 })
                ),
                
                // å…·ä½“å®Œæˆä»»åŠ¡åˆ—è¡¨
                createElement('h3', { className: "text-xl font-bold border-b pb-2 mt-4" }, 'ä»»åŠ¡å®Œæˆè®°å½•'),
                filteredTasks.length > 0 ? filteredTasks.map(t => createElement('div', { key: t.id, className: "bg-white p-3 rounded-lg shadow-sm flex justify-between items-center mb-2 border-l-4 border-green-500" },
                    createElement('div', { className: "flex items-center gap-2" },
                        createElement('span', { className: "text-xl" }, t.icon),
                        createElement('p', { className: "font-medium" }, t.title)
                    ),
                    createElement('div', { className: "text-xs text-gray-500 text-right" },
                        createElement('p', { className: "text-yellow-600 font-bold flex items-center" }, createElement(Icons.Star, { className: "w-3 h-3 mr-0.5 fill-current" }), t.stars),
                        createElement('p', null, t.completedAt)
                    )
                )) : createElement('p', {className: 'text-gray-500 text-center py-5'}, 'æœ¬å‘¨æš‚æ— è®°å½•')
            );
        };
        
        // --- 6. æˆå‘˜ç®¡ç†è§†å›¾ (MembersView) ---
        const MembersView = ({ members, handleEditMemberStart, handleDeleteMember, handleAddMember }) => {
            const renderMemberCard = (member) => {
                return createElement('div', { 
                    key: member.id, 
                    className: `bg-white p-5 rounded-xl shadow-premium border-l-4 ${member.border} mb-4`
                },
                    createElement('div', { className: "flex items-center justify-between" },
                        createElement('div', { className: "flex items-center gap-4" },
                            createElement('div', { className: `w-16 h-16 rounded-full flex items-center justify-center text-3xl ${member.color}` }, member.avatar),
                            createElement('div', null,
                                createElement('h3', { className: "text-lg font-bold text-gray-800" }, member.name),
                                createElement('div', { className: "flex items-center gap-2 text-yellow-600 mt-1" },
                                    createElement(Icons.Star, { className: "w-4 h-4 fill-current" }),
                                    createElement('span', { className: "font-medium" }, `${member.stars} é¢—æ˜Ÿæ˜Ÿ`)
                                )
                            )
                        ),
                        createElement('div', { className: "flex gap-2" },
                            createElement('button', { 
                                onClick: () => handleEditMemberStart(member), 
                                className: "p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition flex items-center justify-center" 
                            }, createElement(Icons.Edit, { className: "w-5 h-5" })),
                            createElement('button', { 
                                onClick: () => handleDeleteMember(member.id, member.name), 
                                className: "p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition flex items-center justify-center" 
                            }, createElement(Icons.Trash, { className: "w-5 h-5" }))
                        )
                    )
                );
            };

            return createElement('div', { className: "pb-20" },
                createElement('div', { className: "flex justify-between items-center mb-6" },
                    createElement('div', { className: "flex items-center gap-2" },
                        createElement(Icons.Users, { className: "w-7 h-7 text-purple-600" }),
                        createElement('h2', { className: "text-2xl font-bold text-gray-800" }, 'å®¶åº­æˆå‘˜')
                    ),
                    createElement('button', { 
                        onClick: handleAddMember, 
                        className: "flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition" 
                    },
                        createElement(Icons.UserPlus, { className: "w-5 h-5" }),
                        'æ·»åŠ æˆå‘˜'
                    )
                ),
                createElement('div', { className: "space-y-3" },
                    members.length > 0 
                        ? members.map(renderMemberCard)
                        : createElement('p', { className: 'text-gray-500 text-center py-10' }, 'è¿˜æ²¡æœ‰æˆå‘˜ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ å§ï¼')
                )
            );
        };

        // --- 7. æ—¥å†é€‰æ‹©å™¨ç»„ä»¶(æ”¯æŒæ”¶èµ·å’Œæ¨ªå‘æ»‘åŠ¨) ---
        const DateSelector = ({ selectedDate, setSelectedDate, tasks }) => {
            const [currentMonthOffset, setCurrentMonthOffset] = useState(0);
            const [isExpanded, setIsExpanded] = useState(false); // é»˜è®¤æ”¶èµ·
            
            const today = new Date('2025-11-26');
            const displayDate = new Date(today.getFullYear(), today.getMonth() + currentMonthOffset, 1);
            const year = displayDate.getFullYear();
            const month = displayDate.getMonth() + 1;
            
            const formatDate = (y, m, day) => {
                const monthStr = m < 10 ? '0' + m : m;
                const dayStr = day < 10 ? '0' + day : day;
                return `${y}-${monthStr}-${dayStr}`;
            };
            
            // ä»Šå¤©æŒ‰é’®ç‚¹å‡»:å›åˆ°å½“å‰æœˆä»½å¹¶é€‰æ‹©ä»Šå¤©
            const handleTodayClick = () => {
                setCurrentMonthOffset(0);
                setSelectedDate('2025-11-26');
            };
            
            // æ‰¾åˆ°ä»Šå¤©æ˜¯æœ¬æœˆç¬¬å‡ å¤©
            const todayDate = new Date('2025-11-26');
            const todayDay = todayDate.getDate();
            const todayMonth = todayDate.getMonth() + 1;
            const todayYear = todayDate.getFullYear();
            const isTodayInCurrentMonth = todayYear === year && todayMonth === month;
            
            // ä½¿ç”¨ useEffect æ»šåŠ¨åˆ°ä»Šå¤©ä½ç½® - å¿…é¡»åœ¨æ¡ä»¶è¯­å¥å¤–éƒ¨
            React.useEffect(() => {
                if (!isExpanded && isTodayInCurrentMonth) {
                    setTimeout(() => {
                        const todayButton = document.getElementById('today-date-button');
                        if (todayButton) {
                            todayButton.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        }
                    }, 100);
                }
            }, [currentMonthOffset, isExpanded, isTodayInCurrentMonth]);
            
            // æ”¶èµ·çŠ¶æ€:æ˜¾ç¤ºæ¨ªå‘æ»‘åŠ¨çš„æ—¥æœŸåˆ—è¡¨(æ˜¾ç¤ºæœ¬æœˆæ‰€æœ‰æ—¥æœŸ)
            if (!isExpanded) {
                const daysInMonth = new Date(year, month, 0).getDate();
                const horizontalDays = [];
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = formatDate(year, month, day);
                    const isToday = dateStr === '2025-11-26';
                    const isSelected = dateStr === selectedDate;
                    const dayTasks = tasks.filter(t => t.date === dateStr);
                    const taskCount = dayTasks.length;
                    const allCompleted = taskCount > 0 && dayTasks.every(t => t.completed);
                    
                    const cardClass = isSelected 
                        ? 'bg-purple-600 text-white font-bold' 
                        : isToday 
                            ? 'bg-green-100 text-green-700 font-medium border border-green-400' 
                            : 'bg-gray-50 text-gray-700';
                    
                    horizontalDays.push(
                        createElement('button', {
                            key: day,
                            id: isToday ? 'today-date-button' : undefined,
                            onClick: () => setSelectedDate(dateStr),
                            className: `flex-shrink-0 w-14 h-16 rounded-xl flex flex-col items-center justify-center transition-all ${cardClass}`
                        },
                            createElement('span', { className: 'text-[10px] text-gray-400' }, `${month}/${day}`),
                            createElement('span', { className: 'text-lg font-bold mt-1' }, day),
                            taskCount > 0 && createElement('div', { 
                                className: `w-1 h-1 rounded-full mt-1 ${isSelected ? 'bg-white' : allCompleted ? 'bg-green-500' : 'bg-orange-400'}` 
                            })
                        )
                    );
                }
                
                return createElement('div', { className: "bg-white rounded-xl shadow-premium p-3 mb-4" },
                    createElement('div', { className: "flex justify-between items-center mb-3" },
                        createElement('div', { className: "flex items-center gap-2" },
                            createElement(Icons.Calendar, { className: "w-5 h-5 text-purple-600" }),
                            createElement('h3', { className: "text-base font-bold text-gray-800" }, `${year}å¹´ ${month}æœˆ`)
                        ),
                        createElement('div', { className: "flex gap-2 items-center" },
                            createElement('button', { 
                                onClick: () => {
                                    handleTodayClick();
                                    setTimeout(() => {
                                        const todayButton = document.getElementById('today-date-button');
                                        if (todayButton) {
                                            todayButton.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                                        }
                                    }, 100);
                                }, 
                                className: "px-2 py-1 text-xs bg-purple-500 text-white rounded flex items-center gap-1 hover:bg-purple-600 transition" 
                            }, 
                                createElement(Icons.Home, { className: "w-3 h-3" }),
                                'ä»Šå¤©'
                            ),
                            createElement('button', { 
                                onClick: () => setCurrentMonthOffset(prev => prev - 1), 
                                className: "p-1 hover:bg-gray-100 rounded" 
                            }, createElement(Icons.ChevronLeft, { className: "w-4 h-4" })),
                            createElement('button', { 
                                onClick: () => setCurrentMonthOffset(prev => prev + 1), 
                                className: "p-1 hover:bg-gray-100 rounded" 
                            }, createElement(Icons.ChevronRight, { className: "w-4 h-4" })),
                            createElement('button', { 
                                onClick: () => setIsExpanded(true), 
                                className: "p-1 hover:bg-gray-100 rounded transition-transform" 
                            }, createElement(Icons.ChevronDown, { className: "w-4 h-4" }))
                        )
                    ),
                    createElement('div', { className: "flex gap-2 overflow-x-auto scrollbar-hide pb-2" }, ...horizontalDays)
                );
            }
            
            // å±•å¼€çŠ¶æ€:æ˜¾ç¤ºæœˆè§†å›¾
            const daysInMonth = new Date(year, month, 0).getDate();
            const firstDayOfWeek = new Date(year, month - 1, 1).getDay();
            const adjustedFirstDay = firstDayOfWeek === 0 ? 7 : firstDayOfWeek;
            
            const days = [];
            for (let i = 1; i < adjustedFirstDay; i++) {
                days.push(createElement('div', { key: `empty-${i}` }));
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(year, month, day);
                const isToday = dateStr === '2025-11-26';
                const isSelected = dateStr === selectedDate;
                const dayTasks = tasks.filter(t => t.date === dateStr);
                const taskCount = dayTasks.length;
                const allCompleted = taskCount > 0 && dayTasks.every(t => t.completed);

                const cardClass = isSelected 
                    ? 'bg-purple-600 text-white font-bold' 
                    : isToday 
                        ? 'bg-green-100 text-green-700 font-medium border border-green-400' 
                        : 'hover:bg-gray-100 text-gray-700';

                days.push(createElement('button', { 
                    key: day, 
                    onClick: () => setSelectedDate(dateStr), 
                    className: `h-10 rounded-lg flex flex-col items-center justify-center relative transition-all ${cardClass}` 
                },
                    createElement('span', { className: `text-xs` }, day),
                    taskCount > 0 && createElement('div', { className: `w-1 h-1 rounded-full mt-0.5 ${isSelected ? 'bg-white' : allCompleted ? 'bg-green-500' : 'bg-gray-400'}` })
                ));
            }

            return createElement('div', { className: "bg-white rounded-xl shadow-premium p-4 mb-4" },
                createElement('div', { className: "flex justify-between items-center mb-3" },
                    createElement('div', { className: "flex items-center gap-2" },
                        createElement(Icons.Calendar, { className: "w-5 h-5 text-purple-600" }),
                        createElement('h3', { className: "text-base font-bold text-gray-800" }, `${year}å¹´ ${month}æœˆ`)
                    ),
                    createElement('div', { className: "flex gap-2 items-center" },
                        createElement('button', { 
                            onClick: handleTodayClick, 
                            className: "px-2 py-1 text-xs bg-purple-500 text-white rounded flex items-center gap-1 hover:bg-purple-600 transition" 
                        }, 
                            createElement(Icons.Home, { className: "w-3 h-3" }),
                            'ä»Šå¤©'
                        ),
                        createElement('button', { 
                            onClick: () => setCurrentMonthOffset(prev => prev - 1), 
                            className: "p-1 hover:bg-gray-100 rounded" 
                        }, createElement(Icons.ChevronLeft, { className: "w-4 h-4" })),
                        createElement('button', { 
                            onClick: () => setCurrentMonthOffset(prev => prev + 1), 
                            className: "p-1 hover:bg-gray-100 rounded" 
                        }, createElement(Icons.ChevronRight, { className: "w-4 h-4" })),
                        createElement('button', { 
                            onClick: () => setIsExpanded(false), 
                            className: "p-1 hover:bg-gray-100 rounded transition-transform" 
                        }, createElement(Icons.ChevronUp, { className: "w-4 h-4" }))
                    )
                ),
                createElement('div', { className: "grid grid-cols-7 text-center text-[10px] text-gray-400 font-bold mb-2" }, 
                    createElement('div', null, 'ä¸€'),
                    createElement('div', null, 'äºŒ'),
                    createElement('div', null, 'ä¸‰'),
                    createElement('div', null, 'å››'),
                    createElement('div', null, 'äº”'),
                    createElement('div', null, 'å…­'),
                    createElement('div', null, 'æ—¥')
                ),
                createElement('div', { className: "grid grid-cols-7 gap-1" }, ...days)
            );
        };

        // --- 8. ä»»åŠ¡è§†å›¾ (ä¼˜åŒ–å) ---
        const TaskListView = ({ tasks, members, getMemberById, selectedDate, setSelectedDate, toggleTask, setIsAddTaskModalOpen }) => {
            const [selectedMemberFilter, setSelectedMemberFilter] = useState('all');
            const [fabPosition, setFabPosition] = useState({ x: null, y: null }); // æ‚¬æµ®æŒ‰é’®ä½ç½®
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            
            const tasksForSelectedDate = tasks.filter(t => t.date === selectedDate);
            const filtered = tasksForSelectedDate.filter(t => 
                selectedMemberFilter === 'all' || 
                t.assignedTo === selectedMemberFilter || 
                (t.competitors && t.competitors.includes(selectedMemberFilter))
            );
            const tasksPending = filtered.filter(t => !t.completed);
            const tasksCompleted = filtered.filter(t => t.completed);
            
            const memberSelector = [
                { id: 'all', name: 'å…¨éƒ¨', avatar: 'ğŸ ' },
                ...members
            ].map(m => createElement('button', {
                key: m.id,
                onClick: () => setSelectedMemberFilter(m.id),
                className: `px-3 py-2 rounded-full text-sm font-medium transition flex items-center gap-2 flex-shrink-0 ${selectedMemberFilter === m.id ? `bg-purple-600 text-white shadow-md` : 'bg-gray-100 text-gray-700'}`
            }, m.avatar, m.name));

            const renderTaskItem = (task) => {
                const assignee = getMemberById(task.assignedTo);
                const isCompleted = task.completed;
                const cardColor = task.taskColor || 'bg-gray-100';
                
                const competitors = task.type === 'competition' 
                    ? task.competitors.map(id => getMemberById(id))
                    : [assignee];
                
                const competitorPills = competitors.map(c => 
                    createElement('span', { key: c.id, className: `px-2 py-0.5 rounded-full text-xs font-medium ${c.text} ${c.color.replace('-500', '-100')}` }, c.avatar)
                );

                return createElement('div', { 
                    key: task.id, 
                    className: `bg-white p-4 rounded-xl shadow-premium flex items-center justify-between border-l-4 ${assignee.border} transition-all mb-3` 
                },
                    createElement('div', { className: "flex items-center gap-3 flex-1" },
                        createElement('div', { className: `w-12 h-12 flex items-center justify-center rounded-lg text-2xl ${cardColor}` }, task.icon),
                        createElement('div', { className: "flex-1" },
                            createElement('h3', { className: `font-medium text-gray-800 ${isCompleted ? 'line-through text-gray-400' : ''}` }, task.title),
                            createElement('div', { className: "flex items-center gap-2 text-xs text-gray-500 mt-1" },
                                createElement('span', { className: "text-yellow-500 flex items-center" }, 
                                    createElement(Icons.Star, { className: "w-3 h-3 mr-0.5 fill-current" }), task.stars
                                ),
                                task.type === 'competition' && createElement('span', { className: "text-purple-600" }, 'ğŸ†ç«äº‰'),
                                task.type === 'collaborative' && createElement('span', { className: "text-green-600" }, 'ğŸ¤å…±åŒ'),
                                task.isRecurring && createElement('span', { className: "text-blue-600" }, 'ğŸ”„å‘¨æœŸ')
                            )
                        )
                    ),
                    createElement('div', { className: "flex flex-col items-end gap-2" },
                        createElement('div', { className: "flex items-center gap-1" }, ...competitorPills),
                        createElement('button', { 
                            onClick: () => toggleTask(task.id), 
                            disabled: isCompleted, 
                            className: "transition-transform active:scale-90" 
                        },
                            isCompleted 
                                ? createElement(Icons.CheckCircle, { className: "w-6 h-6 text-green-500 fill-current" }) 
                                : createElement(Icons.Circle, { className: "w-6 h-6 text-gray-300 hover:text-purple-500" })
                        )
                    )
                );
            };
            
            // æ‚¬æµ®æŒ‰é’®æ‹–æ‹½å¤„ç†
            const handleFabMouseDown = (e) => {
                setIsDragging(true);
                setDragStart({ x: e.clientX, y: e.clientY });
            };
            
            const handleFabTouchStart = (e) => {
                setIsDragging(true);
                const touch = e.touches[0];
                setDragStart({ x: touch.clientX, y: touch.clientY });
            };
            
            React.useEffect(() => {
                const handleMove = (clientX, clientY) => {
                    if (isDragging) {
                        const deltaX = clientX - dragStart.x;
                        const deltaY = clientY - dragStart.y;
                        
                        setFabPosition(prev => ({
                            x: (prev.x || 0) + deltaX,
                            y: (prev.y || 0) + deltaY
                        }));
                        
                        setDragStart({ x: clientX, y: clientY });
                    }
                };
                
                const handleMouseMove = (e) => handleMove(e.clientX, e.clientY);
                const handleTouchMove = (e) => {
                    const touch = e.touches[0];
                    handleMove(touch.clientX, touch.clientY);
                };
                
                const handleEnd = () => setIsDragging(false);
                
                if (isDragging) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleEnd);
                    document.addEventListener('touchmove', handleTouchMove);
                    document.addEventListener('touchend', handleEnd);
                }
                
                return () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleEnd);
                    document.removeEventListener('touchmove', handleTouchMove);
                    document.removeEventListener('touchend', handleEnd);
                };
            }, [isDragging, dragStart]);
            
            const fabStyle = fabPosition.x !== null ? {
                right: 'auto',
                bottom: 'auto',
                left: `calc(100% - 80px + ${fabPosition.x}px)`,
                top: `calc(100% - 140px + ${fabPosition.y}px)`
            } : {};
            
            return createElement('div', { className: "space-y-4 pb-20" },
                // æ—¥å†é€‰æ‹©å™¨
                createElement(DateSelector, { selectedDate, setSelectedDate, tasks }),
                
                // æˆå‘˜ç­›é€‰
                createElement('div', { className: "flex space-x-3 overflow-x-auto pb-4 scrollbar-hide" }, ...memberSelector),
                
                // ä»»åŠ¡åˆ—è¡¨
                createElement('div', { className: "space-y-3" },
                    tasksPending.length > 0 
                        ? tasksPending.map(renderTaskItem) 
                        : createElement('p', { className: 'text-gray-500 text-center py-10 bg-white rounded-xl' }, 'âœ¨ æš‚æ— å¾…å®Œæˆä»»åŠ¡'),
                    tasksCompleted.length > 0 && createElement('h3', { className: "font-bold text-gray-500 mt-6 mb-3" }, 'âœ… å·²å®Œæˆ'),
                    tasksCompleted.map(renderTaskItem)
                ),
                
                // å¯æ‹–æ‹½çš„æ·»åŠ ä»»åŠ¡æŒ‰é’®
                createElement('button', { 
                    onClick: () => !isDragging && setIsAddTaskModalOpen(true),
                    onMouseDown: handleFabMouseDown,
                    onTouchStart: handleFabTouchStart,
                    style: fabStyle,
                    className: `fixed ${fabPosition.x === null ? 'bottom-20 right-6' : ''} bg-purple-600 text-white w-14 h-14 rounded-full shadow-lg hover:bg-purple-700 transition flex items-center justify-center cursor-move z-30`
                }, 
                    createElement(Icons.Plus, { className: "w-8 h-8" })
                )
            );
        };

        // --- 9. ç¼–è¾‘æˆå‘˜æ¨¡æ€æ¡† ---
        const EditMemberModal = ({ member, onClose, onSave }) => {
            const [name, setName] = useState(member.name);
            const [stars, setStars] = useState(member.stars);
            const [avatar, setAvatar] = useState(member.avatar);

            const handleSave = () => {
                if (!name || stars < 0) return;
                onSave({ ...member, name, stars, avatar });
            };

            return createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" },
                createElement('div', { className: "bg-white w-full max-w-sm rounded-xl p-6 shadow-premium space-y-4" },
                    createElement('div', { className: "flex items-center justify-between border-b pb-3" },
                        createElement('h2', { className: "text-xl font-bold flex items-center gap-2" }, 
                            createElement(Icons.Edit, { className: "w-5 h-5 text-purple-600" }),
                            `ç¼–è¾‘æˆå‘˜`
                        ),
                        createElement('button', { 
                            onClick: onClose, 
                            className: "p-1 hover:bg-gray-100 rounded transition" 
                        }, createElement(Icons.X, { className: "w-5 h-5 text-gray-500" }))
                    ),
                    
                    // å§“åè¾“å…¥
                    createElement('div', { className: "flex items-center gap-4" }, 
                        createElement(Icons.List, { className: "w-5 h-5 text-gray-500" }),
                        createElement('input', { type: "text", value: name, onChange: (e) => setName(e.target.value), className: "w-full border-b focus:outline-none py-1", placeholder: "å§“å" })
                    ),
                    
                    // æ˜Ÿæ˜Ÿè¾“å…¥
                    createElement('div', { className: "flex items-center gap-4" }, 
                        createElement(Icons.Star, { className: "w-5 h-5 text-yellow-500 fill-current" }),
                        createElement('input', { type: "number", min: 0, value: stars, onChange: (e) => setStars(parseInt(e.target.value) || 0), className: "w-full border-b focus:outline-none py-1", placeholder: "æ˜Ÿæ˜Ÿæ•°é‡" })
                    ),
                    
                    // å¤´åƒè¾“å…¥
                    createElement('div', { className: "flex items-center gap-4" }, 
                        createElement('span', { className: "text-xl" }, avatar),
                        createElement('input', { type: "text", maxLength: 2, value: avatar, onChange: (e) => setAvatar(e.target.value), className: "w-full border-b focus:outline-none py-1", placeholder: "å¤´åƒ (Emoji)" })
                    ),

                    // æŒ‰é’®
                    createElement('div', { className: "flex justify-end gap-3 pt-4" },
                        createElement('button', { onClick: onClose, className: "px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300" }, 'å–æ¶ˆ'),
                        createElement('button', { onClick: handleSave, className: "px-4 py-2 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700" }, 'ä¿å­˜')
                    )
                )
            );
        };
        
        // --- 10. ä»»åŠ¡åˆ›å»ºè¡¨å• (æ”¯æŒå‘¨æœŸæ€§å’Œå…±åŒä»»åŠ¡) ---
        const AddTaskModal = ({ onClose, onSave, members }) => {
            const [title, setTitle] = useState('');
            const [selectedMembers, setSelectedMembers] = useState(members[0] ? [members[0].id] : []);
            const [stars, setStars] = useState(1);
            const [priority, setPriority] = useState('low');
            const [taskType, setTaskType] = useState('individual'); // individual, competition, collaborative
            const [isRecurring, setIsRecurring] = useState(false);
            const [recurringType, setRecurringType] = useState('daily'); // daily, weekly, monthly
            const [dateToggle] = useState(true);

            const handleToggleMember = (id) => {
                if (taskType === 'individual') {
                    setSelectedMembers([id]);
                } else {
                    setSelectedMembers(prev => prev.includes(id) ? prev.filter(mid => mid !== id) : [...prev, id]);
                }
            };

            const handleSave = () => {
                if (!title || selectedMembers.length === 0) { alert('è¯·å¡«å†™æ ‡é¢˜å¹¶é€‰æ‹©æˆå‘˜'); return; }
                
                const newTask = {
                    id: `t${Date.now()}`,
                    title: title,
                    assignedTo: selectedMembers[0], 
                    date: dateToggle ? '2025-11-26' : null, 
                    completed: false,
                    stars: stars,
                    priority: priority,
                    icon: taskType === 'competition' ? 'ğŸ†' : taskType === 'collaborative' ? 'ğŸ¤' : 'ğŸŒŸ', 
                    taskColor: taskType === 'competition' ? 'bg-yellow-100' : taskType === 'collaborative' ? 'bg-green-100' : 'bg-indigo-100',
                    type: taskType,
                    competitors: (taskType === 'competition' || taskType === 'collaborative') ? selectedMembers : undefined,
                    isRecurring: isRecurring,
                    recurringType: isRecurring ? recurringType : null,
                };
                onSave(newTask);
            };

            const memberPills = members.map(m => createElement('button', {
                key: m.id,
                onClick: () => handleToggleMember(m.id),
                className: `px-3 py-1 rounded-full text-sm font-medium transition flex items-center gap-2 ${selectedMembers.includes(m.id) ? `${m.color} text-white` : 'bg-gray-100 text-gray-700'}`
            }, m.avatar, m.name, selectedMembers.includes(m.id) ? 'âœ“' : null));

            const timeAndRepeatItems = [
                { icon: Icons.Calendar, label: 'æ—¥æœŸ', value: '2025-11-26', toggle: dateToggle, setToggle: () => {} },
                { icon: Icons.Clock, label: 'æ—¶é—´', value: 'æ— æ—¶é—´é™åˆ¶', toggle: false, setToggle: () => {} },
            ].map(item => createElement('div', { key: item.label, className: "flex justify-between items-center py-2" },
                createElement('div', { className: "flex items-center gap-3" }, createElement(item.icon, { className: "w-6 h-6 text-gray-500" }), item.label, createElement('span', { className: "text-gray-500 text-sm" }, item.value)),
                createElement('input', { type: "checkbox", checked: item.toggle, onChange: (e) => item.setToggle(e.target.checked), className: "toggle-switch hidden" })
            ));
            
            const priorityMap = { low: 'ä½', medium: 'ä¸­', high: 'é«˜' };
            const priorityButtons = ['low', 'medium', 'high'].map(p => createElement('button', {
                key: p,
                onClick: () => setPriority(p),
                className: `px-3 py-1 rounded text-sm transition ${priority === p ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-700'}`
            }, priorityMap[p]));

            const taskTypeButtons = [
                { id: 'individual', label: 'ä¸ªäººä»»åŠ¡', icon: 'ğŸ‘¤' },
                { id: 'competition', label: 'ç«äº‰ä»»åŠ¡', icon: 'ğŸ†' },
                { id: 'collaborative', label: 'å…±åŒä»»åŠ¡', icon: 'ğŸ¤' }
            ].map(t => createElement('button', {
                key: t.id,
                onClick: () => { 
                    setTaskType(t.id); 
                    if (t.id === 'individual') setSelectedMembers([selectedMembers[0] || members[0].id]); 
                },
                className: `px-3 py-2 rounded-lg text-sm transition flex items-center gap-1 ${taskType === t.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-100 text-gray-700'}`
            }, t.icon, t.label));

            const recurringButtons = [
                { id: 'daily', label: 'æ¯å¤©' },
                { id: 'weekly', label: 'æ¯å‘¨' },
                { id: 'monthly', label: 'æ¯æœˆ' }
            ].map(r => createElement('button', {
                key: r.id,
                onClick: () => setRecurringType(r.id),
                disabled: !isRecurring,
                className: `px-3 py-1 rounded text-sm transition ${recurringType === r.id && isRecurring ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700'} ${!isRecurring ? 'opacity-50' : ''}`
            }, r.label));

            return createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-end" },
                createElement('div', { className: "bg-white w-full max-w-md rounded-t-3xl p-6 h-[90%] overflow-y-auto" },
                    // Header
                    createElement('div', { className: "flex justify-between items-center mb-6" },
                        createElement('button', { 
                            onClick: onClose, 
                            className: "p-2 hover:bg-gray-100 rounded-lg transition flex items-center justify-center" 
                        }, createElement(Icons.X, { className: "w-6 h-6 text-gray-500" })),
                        createElement('h2', { className: "text-xl font-bold flex items-center gap-2" }, 
                            createElement(Icons.Plus, { className: "w-5 h-5 text-purple-600" }),
                            'æ·»åŠ ä»»åŠ¡'
                        ),
                        createElement('button', { 
                            onClick: handleSave, 
                            className: "px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition flex items-center gap-1" 
                        }, 
                            createElement(Icons.CheckCircle, { className: "w-4 h-4" }),
                            'ä¿å­˜'
                        )
                    ),

                    // Form Fields
                    createElement('div', { className: "space-y-4" },
                        createElement('div', { className: "border-b pb-4" }, createElement('input', { type: "text", placeholder: "*æ ‡é¢˜", className: "w-full text-xl font-medium focus:outline-none", value: title, onChange: (e) => setTitle(e.target.value) })),
                        createElement('div', { className: "space-y-2 text-gray-700" }, ...timeAndRepeatItems),
                        
                        // å‘¨æœŸæ€§ä»»åŠ¡
                        createElement('div', { className: "border-t py-4" },
                            createElement('div', { className: "flex items-center justify-between mb-3" },
                                createElement('p', { className: "font-medium" }, 'å‘¨æœŸæ€§ä»»åŠ¡'),
                                createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                    createElement('input', { 
                                        type: "checkbox", 
                                        checked: isRecurring, 
                                        onChange: (e) => setIsRecurring(e.target.checked),
                                        className: "sr-only peer" 
                                    }),
                                    createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600" })
                                )
                            ),
                            isRecurring && createElement('div', { className: "flex gap-2" }, ...recurringButtons)
                        ),
                        
                        createElement('div', { className: "flex items-center justify-between border-t py-4" }, createElement('div', { className: "flex items-center gap-2" }, createElement(Icons.Star, { className: "w-6 h-6 text-yellow-500 fill-current" }), 'æ˜Ÿæ˜Ÿ'), createElement('input', { type: "number", min: 1, max: 10, value: stars, onChange: (e) => setStars(parseInt(e.target.value) || 1), className: "w-12 text-center border rounded" })),
                        createElement('div', { className: "border-t py-4" }, createElement('p', { className: "font-medium mb-3" }, '*ä»»åŠ¡ç±»å‹'), createElement('div', { className: "flex gap-2 flex-wrap" }, ...taskTypeButtons)),
                        createElement('div', { className: "border-b py-4" }, createElement('p', { className: "font-medium mb-3" }, '*é€‰æ‹©æˆå‘˜'), createElement('div', { className: "flex flex-wrap gap-2" }, ...memberPills)),
                        createElement('div', { className: "border-b py-4" }, createElement('p', { className: "font-medium mb-3" }, 'ä¼˜å…ˆçº§'), createElement('div', { className: "flex gap-4" }, ...priorityButtons))
                    )
                )
            );
        };
        
        // --- 11. ä¸»åº”ç”¨ç»„ä»¶ ---
        function FamilyTaskApp() {
            const [activeTab, setActiveTab] = useState('tasks');
            const [members, setMembers] = useState(INITIAL_MEMBERS);
            const [tasks, setTasks] = useState(INITIAL_TASKS);
            const [rewards, setRewards] = useState(INITIAL_REWARDS);
            const [rewardHistory, setRewardHistory] = useState(INITIAL_REWARD_HISTORY);
            const [isAddTaskModalOpen, setIsAddTaskModalOpen] = useState(false); 
            const [selectedDate, setSelectedDate] = useState('2025-11-26'); 
            const [isEditMemberModalOpen, setIsEditMemberModalOpen] = useState(null); 
            const [isAddRewardModalOpen, setIsAddRewardModalOpen] = useState(false); 
            const [isStarEffectActive, setIsStarEffectActive] = useState(false);
            const [isCongratulateActive, setIsCongratulateActive] = useState(false);
            const [confettiPieces, setConfettiPieces] = useState([]);
            const [competitionWinner, setCompetitionWinner] = useState(null); // ç”¨äºç«äº‰ä»»åŠ¡é€‰æ‹©è·èƒœè€…
            
            const getMemberById = (id) => members.find(m => m.id === id);

            // --- æˆå‘˜ CRUD ---
            const handleAddMember = () => {
                const name = prompt("è¯·è¾“å…¥æ–°æˆå‘˜çš„å§“å:");
                if (!name) return;
                const avatar = prompt("è¯·è¾“å…¥æ–°æˆå‘˜çš„å¤´åƒ (è¡¨æƒ…ç¬¦å·):", "ğŸ‘¶");
                
                const newId = `m${Date.now()}`;
                const colors = ['bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-purple-500', 'bg-yellow-500'];
                const texts = ['text-blue-600', 'text-green-600', 'text-red-600', 'text-purple-600', 'text-yellow-600'];
                const index = Math.floor(Math.random() * colors.length);

                setMembers(prev => [...prev, { 
                    id: newId, 
                    name, 
                    avatar, 
                    color: colors[index], 
                    text: texts[index], 
                    border: colors[index].replace('bg-', 'border-'), 
                    stars: 0 
                }]);
            };

            const handleDeleteMember = (id, name) => {
                if (window.confirm(`ç¡®å®šåˆ é™¤æˆå‘˜ ${name} å—ï¼Ÿå°†åŒæ—¶åˆ é™¤ç›¸å…³ä»»åŠ¡å’Œå¥–åŠ±ã€‚`)) {
                    setMembers(prev => prev.filter(m => m.id !== id));
                    setTasks(prev => prev.filter(t => t.assignedTo !== id));
                    setRewards(prev => prev.filter(r => r.assignedTo !== id));
                }
            };
            
            const handleEditMemberStart = (member) => {
                setIsEditMemberModalOpen(member);
            };

            const handleEditMemberSave = (updatedMember) => {
                setMembers(prev => prev.map(m => m.id === updatedMember.id ? updatedMember : m));
                setIsEditMemberModalOpen(null);
            };
            
            // --- ä»»åŠ¡æ“ä½œ ---
            const handleAddTask = (newTask) => {
                setTasks(prev => [...prev, newTask]);
                setIsAddTaskModalOpen(false);
            };

            const toggleTask = (taskId, selectedWinnerId = null) => {
                const task = tasks.find(t => t.id === taskId);
                if (!task || task.completed) return; 
                
                const today = '2025-11-26';
                
                // ç«äº‰ä»»åŠ¡:éœ€è¦é€‰æ‹©è·èƒœè€…
                if (task.type === 'competition' && !selectedWinnerId) {
                    setCompetitionWinner(taskId);
                    return;
                }
                
                // å…±åŒä»»åŠ¡:æ‰€æœ‰å‚ä¸è€…éƒ½è·å¾—æ˜Ÿæ˜Ÿ
                if (task.type === 'collaborative') {
                    const participants = task.competitors || [task.assignedTo];
                    setTasks(prev => prev.map(t => t.id === taskId ? { 
                        ...t, 
                        completed: true, 
                        completedAt: today,
                        participants: participants
                    } : t));
                    
                    setMembers(prev => prev.map(m => 
                        participants.includes(m.id) ? { ...m, stars: m.stars + task.stars } : m
                    ));
                } else {
                    // ä¸ªäººä»»åŠ¡æˆ–ç«äº‰ä»»åŠ¡(å·²é€‰æ‹©è·èƒœè€…)
                    const winnerId = selectedWinnerId || task.assignedTo;
                    
                    setTasks(prev => prev.map(t => t.id === taskId ? { 
                        ...t, 
                        completed: true, 
                        winnerId: winnerId, 
                        completedAt: today
                    } : t));
                    
                    setMembers(prev => prev.map(m => 
                        m.id === winnerId ? { ...m, stars: m.stars + task.stars } : m
                    ));
                }
                
                // è§¦å‘æ­å–œåŠ¨ç”»
                setIsCongratulateActive(true);
                
                // ç”Ÿæˆå½©çº¸
                const newConfetti = Array.from({ length: 30 }, (_, i) => ({
                    id: i,
                    left: Math.random() * 100,
                    delay: Math.random() * 0.5,
                    color: ['#FFD700', '#FF69B4', '#00CED1', '#FF6347', '#9370DB'][Math.floor(Math.random() * 5)]
                }));
                setConfettiPieces(newConfetti);
                
                setTimeout(() => {
                    setIsCongratulateActive(false);
                    setConfettiPieces([]);
                    setCompetitionWinner(null);
                }, 3000);
            };

            // --- å¥–åŠ±æ“ä½œ ---
            const handleAddReward = (newReward) => {
                setRewards(prev => [...prev, newReward]);
                setIsAddRewardModalOpen(false);
            };

            const redeemReward = (rewardId, cost, memberId) => {
                const member = members.find(m => m.id === memberId);
                const reward = rewards.find(r => r.id === rewardId);

                if (member && member.stars >= cost) {
                    if (window.confirm(`ç¡®è®¤æ¶ˆè€— ${cost} é¢—æ˜Ÿæ˜Ÿå…‘æ¢ "${reward.name}" å—ï¼Ÿ`)) {
                        const today = '2025-11-26';
                        setMembers(prev => prev.map(m => m.id === memberId ? { ...m, stars: m.stars - cost } : m));
                        setRewards(prev => prev.map(r => r.id === rewardId ? { ...r, progress: r.progress + 1 } : r));
                        
                        // æ·»åŠ å…‘æ¢è®°å½•
                        const historyItem = {
                            id: `h${Date.now()}`,
                            rewardId: rewardId,
                            rewardName: reward.name,
                            memberId: memberId,
                            memberName: member.name,
                            cost: cost,
                            date: today,
                            icon: reward.icon
                        };
                        setRewardHistory(prev => [historyItem, ...prev]);
                    }
                } else {
                    alert(`æ˜Ÿæ˜Ÿä¸å¤Ÿå“¦ï¼è¿˜éœ€è¦ ${cost - member.stars} é¢—æ˜Ÿæ˜Ÿã€‚â­`);
                }
            };
            
            const StarBurstEffect = () => createElement('div', { className: "star-burst text-5xl text-yellow-500" }, 'âœ¨');
            
            // SVG æ­å–œåŠ¨ç”»ç»„ä»¶
            const CongratulateEffect = () => {
                return createElement('div', { className: "congratulate-popup" },
                    createElement('div', { className: "bg-white rounded-3xl p-8 shadow-2xl text-center" },
                        createElement('div', { className: "text-6xl mb-4" }, 'ğŸ‰'),
                        createElement('h2', { className: "text-3xl font-bold text-purple-600 mb-2" }, 'æ­å–œå®Œæˆï¼'),
                        createElement('p', { className: "text-gray-600" }, 'å¤ªæ£’äº†ï¼Œç»§ç»­åŠ æ²¹ï¼'),
                        createElement('div', { className: "mt-4" },
                            createElement('svg', { width: "100", height: "100", viewBox: "0 0 100 100", className: "mx-auto" },
                                createElement('circle', { cx: "50", cy: "50", r: "45", fill: "none", stroke: "#9333EA", strokeWidth: "4", strokeDasharray: "283", strokeDashoffset: "0" },
                                    createElement('animate', { attributeName: "stroke-dashoffset", from: "283", to: "0", dur: "0.6s", fill: "freeze" })
                                ),
                                createElement('path', { d: "M 30 50 L 45 65 L 70 35", fill: "none", stroke: "#9333EA", strokeWidth: "5", strokeLinecap: "round", strokeLinejoin: "round", strokeDasharray: "50", strokeDashoffset: "0" },
                                    createElement('animate', { attributeName: "stroke-dashoffset", from: "50", to: "0", dur: "0.4s", begin: "0.3s", fill: "freeze" })
                                )
                            )
                        )
                    )
                );
            };
            
            // --- ç«äº‰ä»»åŠ¡è·èƒœè€…é€‰æ‹©æ¨¡æ€æ¡† ---
            const CompetitionWinnerModal = ({ taskId, onClose }) => {
                const task = tasks.find(t => t.id === taskId);
                if (!task) return null;
                
                const competitors = task.competitors.map(id => getMemberById(id));
                
                return createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" },
                    createElement('div', { className: "bg-white w-full max-w-sm rounded-xl p-6 shadow-premium" },
                        createElement('div', { className: "text-center mb-6" },
                            createElement('div', { className: "text-5xl mb-3" }, 'ğŸ†'),
                            createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-2" }, 'é€‰æ‹©è·èƒœè€…'),
                            createElement('p', { className: "text-gray-600 text-sm" }, `è°å®Œæˆäº†ä»»åŠ¡"${task.title}"?`)
                        ),
                        createElement('div', { className: "space-y-3 mb-6" },
                            competitors.map(member => 
                                createElement('button', {
                                    key: member.id,
                                    onClick: () => {
                                        toggleTask(taskId, member.id);
                                        onClose();
                                    },
                                    className: `w-full flex items-center gap-4 p-4 rounded-xl border-2 border-gray-200 hover:border-purple-500 hover:bg-purple-50 transition`
                                },
                                    createElement('div', { className: `w-14 h-14 rounded-full flex items-center justify-center text-2xl ${member.color}` }, member.avatar),
                                    createElement('div', { className: "flex-1 text-left" },
                                        createElement('p', { className: "font-bold text-gray-800" }, member.name),
                                        createElement('p', { className: "text-sm text-gray-500" }, `è·å¾— ${task.stars} é¢—æ˜Ÿæ˜Ÿ`)
                                    ),
                                    createElement(Icons.ChevronRight, { className: "w-5 h-5 text-gray-400" })
                                )
                            )
                        ),
                        createElement('button', { 
                            onClick: onClose,
                            className: "w-full px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition" 
                        }, 'å–æ¶ˆ')
                    )
                );
            };
            
            // --- å¥–åŠ±æ¨¡æ€æ¡† ---
            const AddRewardModal = ({ onClose, onSave }) => {
                const [name, setName] = useState('');
                const [cost, setCost] = useState(10);
                const [assignedTo, setAssignedTo] = useState(members[0] ? members[0].id : '');
                const [icon, setIcon] = useState('ğŸ');

                const handleSave = () => {
                    if (!name || cost <= 0 || !assignedTo) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                    onSave({
                        id: `r${Date.now()}`,
                        name,
                        cost,
                        assignedTo,
                        icon: icon || 'ğŸ',
                        progress: 0,
                    });
                };

                return createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-end" },
                    createElement('div', { className: "bg-white w-full max-w-md rounded-t-3xl p-6" },
                        createElement('div', { className: "flex items-center justify-between mb-4" },
                            createElement('h2', { className: "text-xl font-bold flex items-center gap-2" }, 
                                createElement(Icons.Trophy, { className: "w-6 h-6 text-pink-600" }),
                                'æ–°å¢å¥–åŠ±ç›®æ ‡'
                            ),
                            createElement('button', { 
                                onClick: onClose, 
                                className: "p-1 hover:bg-gray-100 rounded transition" 
                            }, createElement(Icons.X, { className: "w-5 h-5 text-gray-500" }))
                        ),
                        
                        createElement('div', { className: "mb-3" }, 
                            createElement('label', { className: "block text-sm font-medium mb-1" }, 'å¥–åŠ±åç§°'),
                            createElement('input', { type: "text", value: name, onChange: (e) => setName(e.target.value), className: "w-full border rounded p-2", placeholder: "ä¾‹å¦‚: è´­ä¹°ä¸€ä¸ªæ–°ç©å…·" })
                        ),
                        createElement('div', { className: "mb-3" }, 
                            createElement('label', { className: "block text-sm font-medium mb-1" }, 'å¥–åŠ±å›¾æ ‡ (Emoji)'),
                            createElement('div', { className: "flex items-center gap-2" },
                                createElement('div', { className: "w-12 h-12 flex items-center justify-center rounded-lg bg-yellow-100 text-2xl" }, icon),
                                createElement('input', { 
                                    type: "text", 
                                    maxLength: 2,
                                    value: icon, 
                                    onChange: (e) => setIcon(e.target.value), 
                                    className: "flex-1 border rounded p-2", 
                                    placeholder: "è¾“å…¥emojiè¡¨æƒ…" 
                                })
                            )
                        ),
                        createElement('div', { className: "mb-3" }, 
                            createElement('label', { className: "block text-sm font-medium mb-1" }, 'æ‰€éœ€æ˜Ÿæ˜Ÿæ•°'),
                            createElement('input', { type: "number", min: 1, value: cost, onChange: (e) => setCost(parseInt(e.target.value) || 1), className: "w-full border rounded p-2" })
                        ),
                        createElement('div', { className: "mb-4" }, 
                            createElement('label', { className: "block text-sm font-medium mb-1" }, 'ç›®æ ‡æˆå‘˜'),
                            createElement('select', { value: assignedTo, onChange: (e) => setAssignedTo(e.target.value), className: "w-full border rounded p-2" },
                                members.map(m => createElement('option', { key: m.id, value: m.id }, m.name))
                            )
                        ),
                        
                        createElement('div', { className: "flex justify-end gap-3" },
                            createElement('button', { onClick: onClose, className: "px-4 py-2 bg-gray-200 rounded-lg" }, 'å–æ¶ˆ'),
                            createElement('button', { onClick: handleSave, className: "px-4 py-2 bg-pink-600 text-white rounded-lg" }, 'åˆ›å»º')
                        )
                    )
                );
            };
            
            // --- å¥–åŠ±è§†å›¾ ---
            const RewardView = () => {
                const [selectedRewardMemberId, setSelectedRewardMemberId] = useState(members[0] ? members[0].id : null);

                if (!selectedRewardMemberId && members.length > 0) {
                    setSelectedRewardMemberId(members[0].id);
                }
                
                if (!selectedRewardMemberId) return createElement('div', {className: 'text-center py-10 text-gray-500'}, 'è¯·å…ˆæ·»åŠ æˆå‘˜');

                const selectedMember = members.find(m => m.id === selectedRewardMemberId);
                const memberRewards = rewards.filter(r => r.assignedTo === selectedMember.id);
                
                // ç­›é€‰å½“å‰æˆå‘˜çš„å…‘æ¢è®°å½•
                const memberRewardHistory = rewardHistory.filter(h => h.memberId === selectedRewardMemberId);
                
                const memberSelector = members.map(m => createElement('button', {
                    key: m.id,
                    onClick: () => setSelectedRewardMemberId(m.id),
                    className: `px-4 py-2 rounded-full text-sm font-medium transition flex items-center gap-2 ${selectedRewardMemberId === m.id ? `bg-pink-500 text-white shadow-md` : 'bg-gray-100 text-gray-700'}`
                }, m.avatar, m.name));

                const rewardList = memberRewards.map(reward => {
                    const progressPercent = Math.min(100, (selectedMember.stars / reward.cost) * 100);
                    const canRedeem = selectedMember.stars >= reward.cost;
                    
                    return createElement('div', { key: reward.id, className: `bg-white p-4 rounded-xl shadow-premium border border-gray-100 mb-4` },
                        createElement('div', { className: "flex gap-4 items-center" },
                            createElement('div', { className: "w-10 h-10 flex items-center justify-center rounded-lg bg-yellow-200 text-2xl" }, reward.icon),
                            createElement('div', { className: "flex-grow" },
                                createElement('h4', { className: "font-medium text-gray-800" }, reward.name),
                                createElement('div', { className: "w-full bg-gray-200 rounded-full h-2.5 mt-1 overflow-hidden" },
                                    createElement('div', { className: "bg-yellow-500 h-2.5 rounded-full transition-all duration-500", style: { width: `${progressPercent}%` } })
                                ),
                                createElement('div', { className: "text-xs text-yellow-700 mt-1 flex justify-between" }, 
                                    `â­ ${selectedMember.stars}/${reward.cost}`, 
                                    canRedeem && createElement('span', {className: 'text-green-600 font-bold'}, 'âœ“ å¯å…‘æ¢')
                                )
                            ),
                            createElement('button', { 
                                onClick: () => redeemReward(reward.id, reward.cost, selectedMember.id), 
                                disabled: !canRedeem,
                                className: `px-3 py-2 rounded-lg text-sm font-medium transition ${canRedeem ? 'bg-purple-600 text-white hover:bg-purple-700' : 'bg-gray-200 text-gray-500'}`
                            }, canRedeem ? 'å…‘æ¢' : 'ä¸è¶³')
                        )
                    );
                });

                return createElement('div', { className: "space-y-6 pb-20" },
                    createElement('h3', { className: "text-xl font-bold" }, 'é€‰æ‹©æˆå‘˜'),
                    createElement('div', { className: "flex space-x-3 overflow-x-auto pb-4 scrollbar-hide" }, ...memberSelector),

                    createElement('div', { className: "flex items-center justify-between p-4 bg-white rounded-xl shadow-premium" }, 
                        createElement('h3', { className: "text-xl font-bold" }, `${selectedMember.name} çš„æ˜Ÿæ˜Ÿ`),
                        createElement('div', { className: "flex items-center gap-2 text-2xl font-bold text-yellow-600" }, 
                            selectedMember.stars, 
                            createElement(Icons.Star, { className: "w-6 h-6 fill-current" })
                        )
                    ),

                    createElement('div', {className: 'flex justify-between items-center'},
                        createElement('h3', { className: "text-xl font-bold" }, 'å¥–åŠ±ç›®æ ‡'),
                        createElement('button', { 
                            onClick: () => setIsAddRewardModalOpen(true), 
                            className: "text-sm text-pink-500 font-medium flex items-center gap-1" 
                        }, 
                            createElement(Icons.Plus, {className: 'w-4 h-4'}), 
                            'åˆ›å»ºå¥–åŠ±'
                        )
                    ),
                    
                    createElement('div', { className: "space-y-4" }, 
                        memberRewards.length > 0 
                            ? rewardList 
                            : createElement('p', {className: 'text-gray-500 text-center py-8 bg-white rounded-xl'}, 'æš‚æ— å¥–åŠ±ç›®æ ‡')
                    ),
                    
                    // å…‘æ¢è®°å½• - ä»…æ˜¾ç¤ºå½“å‰æˆå‘˜
                    createElement('h3', { className: "text-xl font-bold flex items-center gap-2 mt-6" }, 
                        createElement(Icons.List, { className: "w-6 h-6 text-purple-600" }),
                        `${selectedMember.name} çš„å…‘æ¢è®°å½•`
                    ),
                    createElement('div', { className: "bg-white rounded-xl shadow-premium p-4" },
                        memberRewardHistory.length > 0 
                            ? createElement('div', { className: "space-y-3" },
                                memberRewardHistory.slice(0, 10).map(item => 
                                    createElement('div', { key: item.id, className: "flex items-center gap-3 p-3 bg-gray-50 rounded-lg" },
                                        createElement('div', { className: "w-10 h-10 flex items-center justify-center rounded-lg bg-pink-100 text-2xl" }, item.icon),
                                        createElement('div', { className: "flex-1" },
                                            createElement('p', { className: "font-medium text-gray-800" }, item.rewardName),
                                            createElement('p', { className: "text-xs text-gray-500" }, item.date)
                                        ),
                                        createElement('div', { className: "text-right" },
                                            createElement('p', { className: "text-sm font-bold text-red-600" }, `-${item.cost}â­`)
                                        )
                                    )
                                )
                            )
                            : createElement('p', { className: 'text-gray-500 text-center py-6' }, 'æš‚æ— å…‘æ¢è®°å½•')
                    ),
                    
                    isAddRewardModalOpen && createElement(AddRewardModal, { onClose: () => setIsAddRewardModalOpen(false), onSave: handleAddReward })
                );
            };

            // --- Tab é…ç½® ---
            const tabs = [
                { id: 'tasks', name: 'ä»»åŠ¡', icon: Icons.List },
                { id: 'rewards', name: 'å¥–åŠ±', icon: Icons.Trophy },
                { id: 'members', name: 'æˆå‘˜', icon: Icons.Users },
                { id: 'stats', name: 'ç»Ÿè®¡', icon: Icons.Chart }
            ];

            const tabTitles = {
                tasks: 'ä»»åŠ¡ä¸­å¿ƒ',
                rewards: 'å¥–åŠ±æ¿€åŠ±',
                members: 'æˆå‘˜ç®¡ç†',
                stats: 'ç»Ÿè®¡åˆ†æ'
            };

            // --- ä¸»æ¸²æŸ“ ---
            return createElement('div', { className: "min-h-screen max-w-md mx-auto bg-gray-50 shadow-2xl overflow-hidden relative font-sans text-gray-900" },
                createElement('header', { className: "bg-white p-4 shadow-sm sticky top-0 z-10 flex items-center gap-3" },
                    createElement('div', { className: "w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center" },
                        tabs.find(t => t.id === activeTab) && createElement(tabs.find(t => t.id === activeTab).icon, { className: "w-6 h-6 text-purple-600" })
                    ),
                    createElement('h1', { className: "text-xl font-extrabold text-gray-800 flex-1" }, tabTitles[activeTab])
                ),
                
                createElement('main', { className: "p-4" },
                    activeTab === 'tasks' && createElement(TaskListView, {
                        tasks, members, getMemberById, selectedDate, setSelectedDate, toggleTask, setIsAddTaskModalOpen
                    }),
                    activeTab === 'rewards' && createElement(RewardView),
                    activeTab === 'members' && createElement(MembersView, {
                        members, handleEditMemberStart, handleDeleteMember, handleAddMember
                    }),
                    activeTab === 'stats' && createElement(StatsView, { tasks, members, getMemberById }) 
                ),

                // ç‰¹æ•ˆ
                isCongratulateActive && createElement(CongratulateEffect),
                confettiPieces.map(piece => 
                    createElement('div', { 
                        key: piece.id, 
                        className: "confetti",
                        style: { 
                            left: `${piece.left}%`, 
                            top: '-20px',
                            backgroundColor: piece.color,
                            animationDelay: `${piece.delay}s`
                        }
                    })
                ),
                
                // æ¨¡æ€æ¡†
                isAddTaskModalOpen && createElement(AddTaskModal, { 
                    onClose: () => setIsAddTaskModalOpen(false), 
                    onSave: handleAddTask, 
                    members 
                }),
                isEditMemberModalOpen && createElement(EditMemberModal, { 
                    member: isEditMemberModalOpen, 
                    onClose: () => setIsEditMemberModalOpen(null), 
                    onSave: handleEditMemberSave 
                }),
                competitionWinner && createElement(CompetitionWinnerModal, {
                    taskId: competitionWinner,
                    onClose: () => setCompetitionWinner(null)
                }),

                // åº•éƒ¨å¯¼èˆª
                createElement('nav', { className: "fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 z-20 flex justify-around items-center max-w-md mx-auto" },
                    tabs.map(tab => {
                        const isActive = activeTab === tab.id;
                        return createElement('button', { 
                            key: tab.id, 
                            onClick: () => setActiveTab(tab.id), 
                            className: `flex flex-col items-center gap-1 transition-colors ${isActive ? 'text-purple-600' : 'text-gray-400'}` 
                        }, 
                            createElement(tab.icon, { className: "w-6 h-6" }), 
                            createElement('span', { className: "text-[10px] font-medium" }, tab.name)
                        );
                    })
                )
            );
        }


        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(createElement(FamilyTaskApp));
    </script>
</body>
</html>
